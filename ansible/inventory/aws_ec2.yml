# Configuration file for the Ansible AWS EC2 Inventory Plugin
plugin: aws_ec2

# Strict control over which instances are included (good for safety)
strict: true

# -------------------------------------------------------------
# Grouping Strategy: How Ansible converts EC2 tags into groups
# -------------------------------------------------------------

# 1. Group by Service Tag: Creates groups like 'tag_Service_mongodb' and 'tag_Service_redis'.
#    This relies on you tagging your EC2 instances with Key: Service, Value: mongodb/redis.
keyed_groups:
  - key: tags.Service
    separator: ""
    prefix: tag_Service_

# 2. Group by Region: Creates groups like 'region_us_east_1' and 'region_eu_central_1'.
groups:
  # The value is derived from the AWS region, replacing hyphens with underscores 
  # to match the format used by the CI/CD matrix's 'target_region' variable.
  region_by_region: region_{{ region | replace('-', '_') }}

# 3. Host Variable Composition: Defines connection variables
compose:
  # Uses the public IP address for connection (standard for public-facing CI/CD)
  ansible_host: public_ip_address
  # Sets the SSH user based on a tag (AnsibleUser), defaulting to 'ubuntu'
  ansible_user: tags.AnsibleUser | default('ubuntu')

# 4. Filters: Only find instances that are running and have a 'Service' tag
filters:
  instance-state-name: running
  "tag:Service": 
    - '*'