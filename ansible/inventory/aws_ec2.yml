---
# Configuration file for the Ansible AWS EC2 Inventory Plugin
# Location: ansible/inventory/aws_ec2.yml

# Specifies the dynamic inventory plugin to use
plugin: aws_ec2

# Strict control over which instances are included (good for safety)
strict: true

# -------------------------------------------------------------
# Grouping Strategy: How Ansible converts EC2 attributes into groups
# -------------------------------------------------------------

keyed_groups:
  # 1. Group by Service Tag: Creates groups like 'tag_Service_mongodb' and 'tag_Service_redis'.
  #    This targets the value of the 'Service' tag.
  - key: tags.Service
    separator: ""
    prefix: tag_Service_
    
  # 2. Group by Region (THE FIX): Creates groups like 'region_us_east_1' and 'region_eu_central_1'.
  #    This uses the native 'placement.region' attribute and applies a Jinja filter 
  #    to replace '-' with '_', which is the correct way to handle dynamic group naming.
  - key: placement.region | replace('-', '_')
    separator: "_"
    prefix: region

# 3. Host Variable Composition: Defines connection variables
compose:
  # Uses the public IP address for connection (required for communication in CI/CD)
  ansible_host: public_ip_address
  # Sets the SSH user based on a tag (AnsibleUser), defaulting to 'ubuntu'
  ansible_user: tags.AnsibleUser | default('ubuntu')

# 4. Filters: Only find instances that are running and have a 'Service' tag
filters:
  instance-state-name: running
  "tag:Service":
    - '*'
...