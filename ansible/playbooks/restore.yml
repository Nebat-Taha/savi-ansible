# -----------------------------------------------------------------------------
# PLAYBOOK: restore.yml - Database Restoration Workflow
#
# PURPOSE: This playbook is designed exclusively for disaster recovery and testing.
#          It executes the necessary roles to download the latest backup files 
#          from the cloud and restore them to the designated database servers.
#
# EXECUTION CONTROL (CI/CD): 
#   This playbook is intended to be executed via the dedicated "Ansible Database Restore"
#   GitHub Actions workflow. The workflow dynamically passes the required tag 
#   (`mongodb_restore` or `redis_restore`) and the target AWS region based on the 
#   user's input choices, ensuring only the necessary restoration play runs.
#
# MANUAL EXECUTION:
#   To run manually, you must use a tag (e.g., `--tags mongodb_restore`) to 
#   select which database restoration play to execute.
#
# License: MIT License 
# Copyright (c) 2025 Nebat Taha / Savi Finance
# All rights reserved.
# -----------------------------------------------------------------------------
---
# This playbook targets the single, explicitly defined host from the 
# runtime-generated 'restore_targets.yml' file.

# PLAY 1: MongoDB Restoration (Verified Correct)
# -----------------------------------------------------------------------------
- name: Conditionally Restore MongoDB instances
  hosts: restore_target_group
  become: yes
  
  tasks:
    - name: Run MongoDB Restoration Role (Conditional)
      ansible.builtin.include_role:
        name: mongodb_restore
      tags: mongodb_restore
      when: db_to_restore is defined and db_to_restore == 'mongodb'

# PLAY 2: Redis Restoration (The Fix for the current error)
# -----------------------------------------------------------------------------
- name: Conditionally Restore Redis instances
  hosts: restore_target_group
  become: yes
  
  # The 'tasks' keyword is necessary to allow conditional logic below.
  tasks:
    - name: Run Redis Restoration Role (Conditional)
      ansible.builtin.include_role:
        name: redis_restore
      tags: redis_restore
      # The 'when' clause is now correctly applied to the task, not the play.
      when: db_to_restore is defined and db_to_restore == 'redis'