--- 
- name: Set up MongoDB database with test data
  hosts: mongodb_servers
  become: yes
  tags:
    - db_setup
  roles:
    - db_setup


- name: Set up secure SSH Tunnel for MongoDB
  hosts: localhost
  gather_facts: false
  connection: local  
  vars:                    # <-- Defines variables for the role
    mongodb_host_ip: "{{ groups['mongodb_servers'][0] }}"
    ssh_local_port: 27017
    ssh_remote_port: 27017
  roles:
    - tunnel_management # ESTABLISHES the tunnel and SETS the PID fact.

- name: Backup MongoDB instances
  hosts: mongodb_servers  # <-- New host group
  become: yes
  roles:
    - mongodb_backup_ssh
  tags:
    - mongodb_backup
  handlers:
    - name: Kill MongoDB SSH Tunnel Process
      ansible.builtin.command: "kill -9 {{ hostvars['localhost']['mongodb_tunnel_pid'] }}"
      delegate_to: localhost               # <--- ADD THIS LINE
      connection: local  
      run_once: true                     # <--- ADD THIS LINE (Good practice)
      when: hostvars['localhost']['mongodb_tunnel_pid'] is defined and hostvars['localhost']['mongodb_tunnel_pid'] | length > 0
      changed_when: true  


- name: Tear down SSH Tunnel
  hosts: localhost
  gather_facts: false
  connection: local   
  tasks:
    - name: Trigger the tunnel teardown handler
      ansible.builtin.include_role:
        name: tunnel_management
        # This points to a simple task file that will explicitly notify the handler.
        tasks_from: teardown_trigger.yml

#- name: Set up Redis database
#  hosts: redis_servers # <-- New host group
#  become: yes
#  roles:
#    - redis_setup
#  tags:
#    - redis_setup



#- name: Backup Redis instances
#  hosts: redis_servers    # <-- New host group
#  become: yes
#  roles:
#    - redis_backup
#  tags:
#    - redis_backup # Optional tag, but good practice



#- name: Apply EC2 instance configurations
  #hosts: ec2
  #become: yes
  #roles:
    #- ec2_user_mgmt

#- name: Enforce AWS API policies
  #hosts: localhost
  #connection: local
  #gather_facts: yes
  #roles:
    #- s3_policy_enforcement

