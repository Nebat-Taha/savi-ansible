# -----------------------------------------------------------------------------
# ROLE: mongodb_restore - MongoDB Restore Automation
#
# FINAL FIX: The B2 authorization step is removed. Instead, the B2_APPLICATION_KEY_ID 
# and B2_APPLICATION_KEY environment variables are explicitly set and exported 
# within the shell environment of the file-finding task, guaranteeing authentication 
# for the 'b2 ls' command. This resolves the empty output issue due to lost session state.
# -----------------------------------------------------------------------------
---


# 1. DEPENDENCY SETUP
# -----------------------------------------------------------------------------

- name: "Ensure mongorestore, b2, and jq are installed"
  ansible.builtin.package:
    name:
      - mongodb-database-tools
      - backblaze-b2
      - jq 
    state: present
  become: true

- name: "Create local restore directory"
  ansible.builtin.file:
    path: /tmp/mongodb_restore
    state: directory
    mode: '0755'
  become: true

# 2. DOWNLOAD LATEST BACKUP
# -----------------------------------------------------------------------------

# NOTE: The separate 'Authorize Backblaze B2 CLI' task is removed, as its state 
# was not persisting across tasks. Credentials are now passed directly below.

- name: "Find and register the most recent backup file in the 'mongodb/' folder"
  ansible.builtin.shell: |
    # 1. Export credentials to make them available to the B2 CLI in this shell session
    export B2_APPLICATION_KEY_ID={{ lookup('env', 'BACKBLAZE_APPLICATION_KEY_ID') }}
    export B2_APPLICATION_KEY={{ lookup('env', 'BACKBLAZE_APPLICATION_KEY') }}
    
    # 2. Use the authorized B2 CLI to list files in the 'mongodb/' subfolder
    /usr/bin/backblaze-b2 ls --long --json nebatn mongodb/ | \
    # 3. Extract the file name of the latest entry
    jq -r '.files[] | .fileName' | \
    sort -r | head -n 1
  become: true
  register: latest_backup_file

# CRITICAL VALIDATION STEP: Ensure a filename was found
- name: "Assert that a backup file was found"
  ansible.builtin.assert:
    that: 
      - latest_backup_file.stdout | trim | length > 0
    fail_msg: "FATAL: No MongoDB backup file found in the 'mongodb/' bucket folder. Cannot proceed with restore. Check file naming or B2 connectivity."

# Separate Task 3: Download the file
- name: "Download the latest backup from Backblaze B2 by name"
  ansible.builtin.shell: |
    # Ensure credentials are exported again for the download command
    export B2_APPLICATION_KEY_ID={{ lookup('env', 'BACKBLAZE_APPLICATION_KEY_ID') }}
    export B2_APPLICATION_KEY={{ lookup('env', 'BACKBLAZE_APPLICATION_KEY') }}
    
    /usr/bin/backblaze-b2 download-file-by-name nebatn "{{ latest_backup_file.stdout | trim }}" /tmp/mongodb_restore/backup.gz
  become: true

# 3. RESTORATION
# -----------------------------------------------------------------------------

- name: "Stop MongoDB service for restoration"
  ansible.builtin.service:
    name: mongod
    state: stopped
  become: true

- name: "Restore MongoDB from the downloaded backup (Secure Local Connection)"
  ansible.builtin.shell: | 
    mongorestore --uri "mongodb://127.0.0.1:27017" --drop --archive=/tmp/mongodb_restore/backup.gz
  become: true
  register: restore_result
  failed_when: restore_result.rc != 0

- name: "Start MongoDB service after restoration"
  ansible.builtin.service:
    name: mongod
    state: started
  become: true

# 4. CLEANUP
# -----------------------------------------------------------------------------

- name: "Clean up local restore directory"
  ansible.builtin.file:
    path: /tmp/mongodb_restore
    state: absent
  become: true

