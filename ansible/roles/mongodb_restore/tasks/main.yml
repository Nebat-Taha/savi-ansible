# -----------------------------------------------------------------------------
# ROLE: mongodb_restore - MongoDB Restore Automation
#
# PURPOSE: Locates the most recent MongoDB archive in the Backblaze B2 bucket, 
#          downloads it to the server, and restores it to the local MongoDB instance.
#
# TARGETS: Runs on hosts belonging to the 'mongodb_servers' group.
# License: MIT License 
# Copyright (c) 2025 Nebat Taha / Savi Finance
# All rights reserved.
# -----------------------------------------------------------------------------
---
# This task ensures that the 'mongodb-database-tools' package, 
# which contains the 'mongorestore' binary, is installed on the target server.
- name: Ensure mongorestore is installed
  ansible.builtin.package:
    name:
      - mongodb-database-tools
      - jq
    state: present
  become: true


# This task ensures that the Backblaze B2 command-line tool is installed, 
# as it is required to download the backup file from the cloud bucket.
- name: Ensure b2 is installed for Backblaze download
  ansible.builtin.package:
    name: backblaze-b2
    state: present
  become: true


# This task creates a temporary directory on the server to store the downloaded backup 
# file before the restoration process begins.
- name: Create local restore directory
  ansible.builtin.file:
    path: /tmp/mongodb_restore
    state: directory
    mode: '0755'
  become: true

- name: Find and download the latest backup file from Backblaze B2
  ansible.builtin.shell: |
    # 1. Authorize B2 using CI/CD secrets
    /usr/bin/backblaze-b2 authorize-account {{ lookup('env', 'BACKBLAZE_APPLICATION_KEY_ID') }} {{ lookup('env', 'BACKBLAZE_APPLICATION_KEY') }}
    
    # 2. Find the latest backup file by sorting the filename (which contains the timestamp)
    LATEST_FILENAME=$(/usr/bin/backblaze-b2 ls --long --json nebatn | \
                      jq -r '.files[] | select(.fileName | startswith("mongodb/")) | .fileName' | \
                      sort -r | head -n 1)
                      
    if [ -z "$LATEST_FILENAME" ]; then
        echo "Error: Could not find any backup files in the 'mongodb/' folder." >&2
        exit 1
    fi

    # 3. Download the latest file to the temporary directory
    DOWNLOAD_PATH="/tmp/mongodb_restore/$(basename "$LATEST_FILENAME")"
    /usr/bin/backblaze-b2 download-file-by-name nebatn "$LATEST_FILENAME" "$DOWNLOAD_PATH"
    
    # 4. Echo the full local path for the next task
    echo "$DOWNLOAD_PATH"
    
  args:
    executable: /bin/bash
  register: downloaded_file_path
  become: true

# 3. RESTORATION (The CRITICAL step)
# -----------------------------------------------------------------------------

# CRITICAL SAFETY STEP: Stop MongoDB service to ensure clean file restoration.
- name: Stop MongoDB service for restoration
  ansible.builtin.service:
    name: mongod
    state: stopped
  become: true

# This command uses 'mongorestore' to restore the downloaded backup. 
- name: Restore MongoDB from the downloaded backup (Secure Local Connection)
  ansible.builtin.shell: | 
    ARCHIVE_PATH="{{ downloaded_file_path.stdout | trim }}"
    mongorestore --uri "mongodb://127.0.0.1:27017" --drop --archive="$ARCHIVE_PATH"
  become: true
  register: restore_result
  # Fail the playbook if the restore command returns a non-zero code
  failed_when: restore_result.rc != 0

# CRITICAL SAFETY STEP: Start MongoDB service after restoration.
- name: Start MongoDB service after restoration
  ansible.builtin.service:
    name: mongod
    state: started
  become: true

# This final step cleans up the local temporary directory and the downloaded 
# backup file to save disk space.
- name: Clean up local restore directory
  ansible.builtin.file:
    path: /tmp/mongodb_restore
    state: absent
  become: true