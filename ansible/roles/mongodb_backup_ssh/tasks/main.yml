# -----------------------------------------------------------------------------
# ROLE: mongodb_backup - MongoDB Backup Automation
#
# PURPOSE:  Creates a full, compressed archive dump of the MongoDB database 
#           and uploads it securely to Backblaze B2.
#
# TARGETS:  Runs on hosts belonging to the 'mongodb_servers' group.
#
# IMPORTANT: This role assumes an SSH tunnel has been established from 
#            localhost:27017 on the runner to the remote database port 27017.
#
# License: MIT License 
# Copyright (c) 2025 Nebat Taha / Savi Finance
# All rights reserved.
# -----------------------------------------------------------------------------
---
# This task ensures the MongoDB service is active before we attempt to interact with the database.
- name: Ensure MongoDB service is running
  ansible.builtin.service:
    name: mongod
    state: started
  become: true

# This task ensures that both the 'mongodb-database-tools' (for mongodump) and
# the 'backblaze-b2' CLI are installed on the target server. 
- name: Ensure mongodump and b2 are installed
  ansible.builtin.package:
    name:
      - mongodb-database-tools
      - backblaze-b2 
    state: present
  become: true


# Creates a temporary directory where the MongoDB dump will be stored before being uploaded
- name: Create local backup directory
  ansible.builtin.file:
    path: /tmp/mongodb_backup
    state: directory
    mode: '0755'

# =================================================================================
# ⚠️ CRITICAL CHANGE: Using 127.0.0.1 to connect through the SSH Tunnel
# =================================================================================
# Creates a MongoDB dump as a single archive file. The connection URI uses 127.0.0.1:27017,
# which is securely forwarded by the SSH tunnel to the remote MongoDB instance.
- name: Create MongoDB dump with a unique name (via SSH Tunnel)
  ansible.builtin.shell: |
    # The --uri uses localhost (127.0.0.1), which is routed by the tunnel.
    mongodump --uri "mongodb://127.0.0.1:27017" --archive=/tmp/mongodb-backup-{{ ansible_date_time.iso8601_basic_short }}.gz
    echo "/tmp/mongodb-backup-{{ ansible_date_time.iso8601_basic_short }}.gz"
  # The echo outputs the full path to the newly created backup file which is captured by the variable "backup_file_info"
  register: backup_file_info
  become: true

# This task authenticates with Backblaze B2 and uploads the backup file. 
- name: Upload MongoDB backup to Backblaze B2
  ansible.builtin.shell: |
    # Authorize and upload in a single shell block:
    # Uses secrets from the CI/CD environment.
    /usr/bin/backblaze-b2 authorize-account {{ lookup('env', 'BACKBLAZE_APPLICATION_KEY_ID') }} {{ lookup('env', 'BACKBLAZE_APPLICATION_KEY') }} && \
    /usr/bin/backblaze-b2 upload-file nebatn "/tmp/mongodb_backup/{{ backup_filename.stdout | trim }}" "mongodb/{{ backup_filename.stdout | trim }}"
 
 # /usr/bin/backblaze-b2 upload-file "nebatn" "{{ backup_file_info.stdout | trim }}" "{{ backup_file_info.stdout | basename | trim }}"
  # NOTE: 'nebatn' is a placeholder bucket name. Substitute it with your actual bucket name.
  become: true

# removes the temporary directory and the backup file
- name: Clean up local backup directory
  ansible.builtin.file:
    path: /tmp/mongodb_backup
    state: absent
  become: true

# Final task required to signal completion and tear down the SSH tunnel
- name: Signal completion to trigger tunnel teardown
  ansible.builtin.command: "echo 'Backup complete. Signalling tunnel teardown.'"
  changed_when: true
  #notify: "Kill MongoDB SSH Tunnel Process"