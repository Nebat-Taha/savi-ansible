---
# Ensure all necessary tools (Backblaze B2 CLI) are installed on the host.
- name: Ensure backblaze-b2 is installed for download
  ansible.builtin.package:
    name: backblaze-b2
    state: present
  become: true

# Use the Redis CLI to determine the exact location where Redis expects the dump.rdb file.
- name: Get Redis configuration directory (dir)
  ansible.builtin.command: redis-cli CONFIG GET dir
  register: redis_dir_output
  changed_when: false
  become: true

# Extract the directory path into a fact.
- name: Set Redis data directory fact
  ansible.builtin.set_fact:
    redis_data_dir: "{{ redis_dir_output.stdout_lines[1] | trim }}"

# ----------------- Critical Restore Block -----------------

# CRITICAL STEP: Stop the Redis service immediately to prevent all client writes 
# and ensure a consistent restore (guarantees RPO=0).
- name: Stop Redis service for restore (FULL DOWNTIME START)
  ansible.builtin.service:
    name: redis-server
    state: stopped
  become: true

# Authorize the Backblaze B2 CLI for download operations.
- name: Authorize Backblaze B2 CLI
  ansible.builtin.shell: |
    /usr/bin/backblaze-b2 authorize-account {{ lookup('env', 'BACKBLAZE_APPLICATION_KEY_ID') }} {{ lookup('env', 'BACKBLAZE_APPLICATION_KEY') }}
  become: true

# Find the most recent backup file in the Backblaze bucket.
- name: Find the most recent RDB backup file in Backblaze
  ansible.builtin.shell: |
    /usr/bin/backblaze-b2 ls nebatn redis/ | grep 'redis-backup-' | tail -1 | awk '{print $NF}'
  become: true
  register: latest_backup_file
  
# Download the latest backup directly to the final 'dump.rdb' path, overwriting the old file.
# This ensures the new file is in place while the service is down.
- name: Download the latest RDB backup
  ansible.builtin.shell: |
    LATEST_FILE="{{ latest_backup_file.stdout | trim }}"
    /usr/bin/backblaze-b2 download-file-by-name nebatn "${LATEST_FILE}" "{{ redis_data_dir }}/dump.rdb"
  become: true

# Restart the Redis service. Redis will automatically detect and load the new 'dump.rdb' file.
- name: Start Redis service to load new RDB file (FULL DOWNTIME END)
  ansible.builtin.service:
    name: redis-server
    state: started
  become: true

# ----------------- Verification -----------------

# Verify that the test data from the backup is present after the restore.
- name: Verify restored test data
  ansible.builtin.command: redis-cli GET test_key_1
  register: redis_restore_check
  changed_when: false
  
- name: Print restored data verification
  ansible.builtin.debug:
    msg: "Restore successful! Verified key: {{ redis_restore_check.stdout }}"