# -----------------------------------------------------------------------------
# ROLE: mongodb_setup - Secure MongoDB Installation and Configuration
#
# PURPOSE: Installs MongoDB (version 7.0) on the target host, secures it by 
#          binding it exclusively to the local loopback address (127.0.0.1),
#          and performs an initial database population test.
#
# TARGETS: Runs on hosts belonging to the 'mongodb_servers' group.
# License: MIT License 
# Copyright (c) 2025 Nebat Taha / Savi Finance
# All rights reserved.
# -----------------------------------------------------------------------------

---
# -----------------------------------------------------------------------------
# PHASE 1: Install MongoDB and Prerequisites
# -----------------------------------------------------------------------------

# Install Prerequisites
- name: Install gnupg and necessary packages
  ansible.builtin.apt:
    name:
      - gnupg # Required for validating the GPG key
      - curl  # Used to download the GPG key
    state: present
    update_cache: yes
  become: true

# Download and Add the official MongoDB GPG Key 
# Download key and use gpg to store it securely in /etc/apt/keyrings/ 
- name: Add MongoDB GPG key 
  ansible.builtin.shell: |
    curl -fsSL https://pgp.mongodb.com/server-7.0.asc | \
      sudo gpg --dearmor -o /etc/apt/keyrings/mongodb-server-7.0.gpg
  args:
    creates: /etc/apt/keyrings/mongodb-server-7.0.gpg
  become: true
  changed_when: true

# Add MongoDB Repository 
- name: Add MongoDB repository for Ubuntu 24.04 (using jammy mirror)
  ansible.builtin.apt_repository:
    repo: 'deb [ signed-by=/etc/apt/keyrings/mongodb-server-7.0.gpg, arch=amd64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse'
    state: present
    filename: 'mongodb-org-7.0'
  become: true

# Install MongoDB
- name: Ensure MongoDB is installed (mongodb-org)
  ansible.builtin.package:
    name: mongodb-org
    state: present
  become: true
  register: mongodb_install_status # Register the installation result to check dependencies if needed later.

# This task ensures that the MongoDB service is started

- name: Check if MongoDB is running
  ansible.builtin.service:
    name: mongod
    state: started
  become: true
# this tasks ensures Secure MongoDB Binding
- name: Configure MongoDB to listen ONLY on localhost (127.0.0.1) for security
  ansible.builtin.replace:
    path: /etc/mongod.conf
    regexp: '^  bindIp: [0-9.]+' # Regex matches and replaces any existing bindIp setting (e.g., 0.0.0.0, 127.0.0.1).
    replace: '  bindIp: 127.0.0.1' # This ensures the database is only accessible from the local host, preventing public exposure. 
  become: true
  register: config_changed
  
# this tasks Restart Service after configuration change 
- name: Restart MongoDB service
  ansible.builtin.service:
    name: mongod
    state: restarted
  become: true

#- name: Reset SSH connection after service restart
#  ansible.builtin.meta:
#    reset_connection

# Pause for Service Initialization   
- name: Wait for MongoDB to start
  ansible.builtin.pause:
    seconds: 10

#- name: Create a test database and a collection with documents
#  community.mongodb.mongodb_shell:
#    db: testdb
#    eval: 'db.testcollection.insertMany([{ name: "ansible_test_data", value: 100 }, { name: "another_test_doc", value: 200 }])'
#  become: true

