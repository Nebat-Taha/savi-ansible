---
# =============================================================================
# ⚠️ MISSING STEP: MongoDB Installation Tasks ⚠️
# The service cannot be started if the package is not installed.
# =============================================================================

# 1. Install Prerequisites
- name: Install gnupg and necessary packages
  ansible.builtin.apt:
    name:
      - gnupg
      - curl
    state: present
    update_cache: yes
  become: true

# 2. Download and Add the official MongoDB GPG Key (Modern Method)
- name: Add MongoDB GPG key (modern method)
  ansible.builtin.shell: |
    # Download key and use gpg to store it securely in /etc/apt/keyrings/
    curl -fsSL https://pgp.mongodb.com/server-7.0.asc | \
      sudo gpg --dearmor -o /etc/apt/keyrings/mongodb-server-7.0.gpg
  args:
    creates: /etc/apt/keyrings/mongodb-server-7.0.gpg
  become: true
  changed_when: true

# 3. Add MongoDB Repository (Targets 'jammy' codename)
- name: Add MongoDB repository for Ubuntu 24.04 (using jammy mirror)
  ansible.builtin.apt_repository:
    # Use the 'jammy' (22.04) codename for the repository path, as 'noble' is not yet published.
    repo: 'deb [ signed-by=/etc/apt/keyrings/mongodb-server-7.0.gpg, arch=amd64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse'
    state: present
    filename: 'mongodb-org-7.0'
  become: true

# 4. Install MongoDB
- name: Ensure MongoDB is installed (mongodb-org)
  ansible.builtin.package:
    name: mongodb-org
    state: present
  become: true
  register: mongodb_install_status # Register the result

# ... (Continue with your existing service and configuration tasks)


- name: Check if MongoDB is running
  ansible.builtin.service:
    name: mongod
    state: started
  become: true

- name: Configure MongoDB to listen ONLY on localhost (127.0.0.1) for security
  ansible.builtin.replace:
    path: /etc/mongod.conf
    regexp: '^  bindIp: [0-9.]+' # Matches 0.0.0.0, 127.0.0.1, etc.
    replace: '  bindIp: 127.0.0.1' # Securely binds to loopback only
  become: true
  register: config_changed
  
  
- name: Restart MongoDB service
  ansible.builtin.service:
    name: mongod
    state: restarted
  become: true

- name: Reset SSH connection after service restart
  ansible.builtin.meta:
    reset_connection
    
- name: Wait for MongoDB to start
  ansible.builtin.pause:
    seconds: 10

- name: Create a test database and a collection with documents
  community.mongodb.mongodb_shell:
    db: testdb
    eval: 'db.testcollection.insertMany([{ name: "ansible_test_data", value: 100 }, { name: "another_test_doc", value: 200 }])'
  become: true

