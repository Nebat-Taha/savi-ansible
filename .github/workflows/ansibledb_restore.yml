name: Ansible Database Restore

on:
  workflow_dispatch:
    inputs:
      database:
        description: 'Select database to restore'
        required: true
        type: choice
        options:
          - mongodb
          - redis

jobs:
  restore-database:
    runs-on: ubuntu-latest
    
    # This is the key part for multi-region support
    strategy:
      matrix:
        aws_region: ["us-east-1"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Configure Backblaze B2 credentials
        run: |
          echo "BACKBLAZE_APPLICATION_KEY_ID=${{ secrets.BACKBLAZE_APPLICATION_KEY_ID }}" >> $GITHUB_ENV
          echo "BACKBLAZE_APPLICATION_KEY=${{ secrets.BACKBLAZE_APPLICATION_KEY }}" >> $GITHUB_ENV
      
      - name: Set up Ansible and Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Install Ansible and dependencies
        run: pip install ansible b2sdk
          
      - name: Run Restore Playbook for Selected Database
        run: ansible-playbook -i ansible/inventory/ ansible/playbooks/restore.yml --tags ${{ inputs.database }}_restore
        env:
          ANSIBLE_CONFIG: ansible/ansible.cfg
          AWS_REGION: ${{ matrix.aws_region }} # This variable is now defined by the matrix